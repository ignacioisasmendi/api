// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // You can change this to "mysql", "sqlite", etc.
}

model User {
  id          String   @id @default(cuid())
  auth0UserId String   @unique
  email       String   @unique
  name        String?
  avatar      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  contents       Content[]
  socialAccounts SocialAccount[]
  oauthStates    OAuthState[]
}

model SocialAccount {
  id             String    @id @default(cuid())
  userId         String
  platform       Platform
  accessToken    String? // Deberías encriptar esto en la aplicación
  refreshToken   String? // Para renovar el accessToken
  expiresAt      DateTime?
  platformUserId String? // ID del usuario en la plataforma (ej: Instagram User ID)
  username       String? // Nombre de usuario en la plataforma
  metadata       Json? // Para datos adicionales específicos de cada plataforma
  isActive       Boolean  @default(true)
  disconnectedAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  publications Publication[]

  @@unique([userId, platform, platformUserId])
  @@index([userId])
  @@index([platform])
  @@index([disconnectedAt])
}

model Content {
  id        String   @id @default(cuid())
  userId    String
  caption   String?  // The actual post text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  publications Publication[]
  media        Media[]

  @@index([userId])
}


model Publication {
  id              String            @id @default(cuid())
  contentId       String
  socialAccountId String
  platform        Platform          // INSTAGRAM, LINKEDIN, FACEBOOK, etc.
  format          ContentFormat     // FEED, STORY, REEL, VIDEO
  publishAt       DateTime
  status          PublicationStatus @default(SCHEDULED)
  error           String?
  customCaption   String?           // Platform-specific caption override
  platformConfig  Json?             // Platform-specific settings
  platformId      String?
  link            String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  content       Content       @relation(fields: [contentId], references: [id], onDelete: Cascade)
  socialAccount SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  mediaUsage    PublicationMedia[] // New relation!

  @@index([publishAt])
  @@index([status])
  @@index([socialAccountId])
  @@index([contentId])
}

model Media {
  id          String    @id @default(cuid())
  contentId   String
  url         String
  key         String
  type        MediaType
  mimeType    String
  size        Int
  width       Int?
  height      Int?
  duration    Int?
  thumbnail   String?
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  
  content         Content            @relation(fields: [contentId], references: [id], onDelete: Cascade)
  publicationUsage PublicationMedia[] // New relation!
  
  @@index([contentId])
  @@index([type])
}

model PublicationMedia {
  id            String   @id @default(cuid())
  publicationId String
  mediaId       String
  order         Int      @default(0) // Order for carousels
  cropData      Json?    // Platform-specific crop/edit data
  
  publication Publication @relation(fields: [publicationId], references: [id], onDelete: Cascade)
  media       Media       @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  
  @@unique([publicationId, mediaId])
  @@index([publicationId])
  @@index([mediaId])
}

model OAuthState {
  id       String  @id @default(uuid())
  state    String  @unique
  provider String
  userId   String
  used     Boolean @default(false)

  createdAt DateTime @default(now())
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([state])
  @@index([userId])
}

enum ContentFormat {
  FEED
  STORY
  REEL
  VIDEO
  CAROUSEL
  ARTICLE      // For LinkedIn
  TWEET        // For X
}

enum PublicationStatus {
  SCHEDULED
  PUBLISHING
  PUBLISHED
  ERROR
}

enum Platform {
  INSTAGRAM
  FACEBOOK
  TIKTOK
  LINKEDIN
  X
}

enum MediaType {
  IMAGE
  VIDEO
  THUMBNAIL
}


model WaitlistEntry {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("waitlist_entries")
}